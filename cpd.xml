<?xml version="1.0" encoding="UTF-8"?>
<pmd-cpd>
<duplication lines="34" tokens="163">
<file line="56" path="/home/steven/fspotcloud/server/src/main/java/fspotcloud/server/control/task/photodelete/DeletePhotosHandler.java"/>
<file line="59" path="/home/steven/fspotcloud/server/src/main/java/fspotcloud/server/control/task/photoremove/RemovePhotosFromTagHandler.java"/>
<codefragment>
<![CDATA[
			Iterator<PhotoRemovedFromTag> it) {
		Photo photo = photos.getById(key);
		if (photo != null) {
			boolean moreImports = false;
			for (String tagId : photo.getTagList()) {
				Tag tagRelated = tagManager.getById(tagId);
				if (tagRelated != null) {
					if (!deleteTagId.equals(tagId)) {
						if (tagRelated.isImportIssued()) {
							moreImports = true;
							break;
						}
					}
				}
			}
			if (!moreImports) {
				photos.delete(key);
				tag.getCachedPhotoList().remove(find(tag.getCachedPhotoList(), key));
			}
		}
		it.remove();
		
	}

	private PhotoInfo find(SortedSet<PhotoInfo> set, String id) {
		for(PhotoInfo info: set) {
			if (info.getId().equals(id)) {
				return info;
			}
		} 
		return null;
	}

}
]]>
</codefragment>
</duplication>
<duplication lines="22" tokens="131">
<file line="33" path="/home/steven/fspotcloud/model-jpa/src/main/java/fspotcloud/model/jpa/tag/TagManagerBase.java"/>
<file line="46" path="/home/steven/fspotcloud/model/src/main/java/fspotcloud/server/model/tag/TagManager.java"/>
<codefragment>
<![CDATA[
		for (Tag tag : getTagDOList()) {
			TagNode node = new TagNode();
			node.setId(tag.getId());
			node.setImportIssued(tag.isImportIssued());
			node.setParentId(tag.getParentId());
			node.setTagName(tag.getTagName());
			node.setCount(tag.getCount());
			SortedSet<PhotoInfo> photoList = tag.getCachedPhotoList();
			if (photoList != null) {
				node.setCachedPhotoList(new PhotoInfoStore(photoList));
			} else {
				throw new IllegalStateException(
						"photoList field of Tag should not be null");
			}
			result.add(node);
		}

		return result;
	}

	public List<String> getTagKeys() {
		List<String> result = new ArrayList<String>();
]]>
</codefragment>
</duplication>
<duplication lines="29" tokens="129">
<file line="14" path="/home/steven/fspotcloud/model-jpa-gae/src/main/java/fspotcloud/model/jpa/gae/peerdatabase/PeerDatabaseEntity.java"/>
<file line="13" path="/home/steven/fspotcloud/model-jpa-j2ee/src/main/java/fspotcloud/model/jpa/peerdatabase/PeerDatabaseEntity.java"/>
<codefragment>
<![CDATA[
@Entity
public class PeerDatabaseEntity extends PeerDatabaseEntityBase {

    @Lob
    byte[] cachedTagTreeData;
    transient private ArrayList<TagNode> cachedTagTree = null;

    public PeerDatabaseEntity() {
    }

    @Override
    public void setCachedTagTree(List<TagNode> cachedTagTree) {
        if (cachedTagTree == null) {
            this.cachedTagTree = null;
            this.cachedTagTreeData = null;
        } else {
            this.cachedTagTree = new ArrayList<TagNode>(cachedTagTree);
            this.cachedTagTreeData = SerializationUtils.serialize(this.cachedTagTree);
        }
    }

    @Override
    public List<TagNode> getCachedTagTree() {
        if (cachedTagTree == null && cachedTagTreeData != null) {
            cachedTagTree = (ArrayList<TagNode>) SerializationUtils.deserialize(cachedTagTreeData);
        }
        return cachedTagTree;
    }
}
]]>
</codefragment>
</duplication>
<duplication lines="47" tokens="128">
<file line="35" path="/home/steven/fspotcloud/model-jpa/src/main/java/fspotcloud/model/jpa/tag/TagEntityBase.java"/>
<file line="39" path="/home/steven/fspotcloud/model/src/main/java/fspotcloud/server/model/tag/TagDO.java"/>
<codefragment>
<![CDATA[
    @Override
    public void setId(String id) {
        this.id = id;
    }

    @Override
    public void setParent(String parent) {
        this.parent = parent;
    }

    @Override
    public String getParent() {
        return parent;
    }

    @Override
    public void setCount(int count) {
        this.count = count;
    }

    @Override
    public int getCount() {
        return count;
    }

    @Override
    public void setTagName(String tagName) {
        this.tagName = tagName;
    }

    @Override
    public String getTagName() {
        return tagName;
    }

    @Override
    public void setParentId(String parentId) {
        this.parentId = parentId;
    }

    @Override
    public String getParentId() {
        return parentId;
    }

    @Override
    public void setCachedPhotoList(TreeSet<PhotoInfo> cachedPhotoList) {
]]>
</codefragment>
</duplication>
<duplication lines="10" tokens="104">
<file line="14" path="/home/steven/fspotcloud/model-jpa-gae/src/main/java/fspotcloud/model/jpa/ModelModule.java"/>
<file line="14" path="/home/steven/fspotcloud/model-jpa-j2ee/src/main/java/fspotcloud/model/jpa/ModelModule.java"/>
<codefragment>
<![CDATA[
public class ModelModule extends AbstractModule {

    @Override
    protected void configure() {
        bind(Photos.class).to(PhotoManager.class).in(Singleton.class);
        bind(PeerDatabases.class).to(PeerDatabaseManager.class).in(
                Singleton.class);
        bind(Tags.class).to(TagManager.class).in(Singleton.class);
        bind(Integer.class).annotatedWith(Names.named("maxDelete")).toInstance(new Integer(100));
        install(new JpaPersistModule("derby"));
]]>
</codefragment>
</duplication>
</pmd-cpd>